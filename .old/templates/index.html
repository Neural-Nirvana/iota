<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Control System - AI Goal-Oriented</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1e1e1e;
            color: white;
            height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .sidebar {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .terminal-panel {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            color: #64ffda;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #64ffda;
        }

        .ai-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            min-height: 200px;
        }

        /* Enhanced AI Messages */
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            position: relative;
        }

        .message.user {
            background: #0066cc;
            text-align: right;
        }

        .message.ai {
            background: #333;
            border-left: 3px solid #64ffda;
        }

        .message.ai.thinking {
            background: #2a2a2a;
            border-left: 3px solid #ffab00;
        }

        .message.ai.permission {
            background: #2d4a2d;
            border-left: 3px solid #4caf50;
        }

        .message.ai.executing {
            background: #2d3a4a;
            border-left: 3px solid #2196f3;
        }

        .message.ai.reasoning {
            background: #4a2d4a;
            border-left: 3px solid #9c27b0;
        }

        .message.ai.goal-achieved {
            background: #2d4a2d;
            border-left: 3px solid #4caf50;
        }

        .message.ai.goal-failed {
            background: #4a2d2d;
            border-left: 3px solid #f44336;
        }

        /* Permission Request Styling */
        .permission-request {
            background: #2d4a2d;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .permission-command {
            background: #1e1e1e;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            color: #64ffda;
        }

        .permission-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .permission-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .permission-btn.allow {
            background: #4caf50;
            color: white;
        }

        .permission-btn.deny {
            background: #f44336;
            color: white;
        }

        .permission-btn.modify {
            background: #ff9800;
            color: white;
        }

        /* Goal Tracking */
        .goal-tracker {
            background: #1e1e1e;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        .goal-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .goal-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }

        .goal-dot.active { background: #2196f3; }
        .goal-dot.success { background: #4caf50; }
        .goal-dot.failed { background: #f44336; }

        .goal-text {
            font-size: 12px;
            color: #ccc;
        }

        .goal-progress {
            font-size: 10px;
            color: #888;
        }

        /* AI Reasoning Display */
        .reasoning-section {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            border-left: 3px solid #9c27b0;
        }

        .reasoning-title {
            color: #9c27b0;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .reasoning-text {
            font-size: 11px;
            color: #bbb;
            line-height: 1.4;
        }

        /* Terminal Styles */
        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .terminal-window {
            flex: 1;
            background: #0c0c0c;
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        .terminal-header {
            background: #333;
            padding: 8px 15px;
            border-bottom: 1px solid #555;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 8px 8px 0 0;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27ca3f; }

        .terminal-title {
            color: #fff;
            font-size: 12px;
            margin-left: 10px;
        }

        .terminal-output {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            color: #64ffda;
            font-size: 13px;
            line-height: 1.4;
            background: #0c0c0c;
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #0c0c0c;
            border-top: 1px solid #333;
        }

        .terminal-prompt {
            color: #64ffda;
            margin-right: 8px;
            font-weight: bold;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            outline: none;
        }

        .terminal-line {
            margin-bottom: 2px;
            word-wrap: break-word;
        }

        .terminal-line.command {
            color: #fff;
        }

        .terminal-line.output {
            color: #64ffda;
        }

        .terminal-line.error {
            color: #ff5722;
        }

        .terminal-line.success {
            color: #4caf50;
        }

        .terminal-line.ai-injected {
            color: #9c27b0;
            background: rgba(156, 39, 176, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .ai-input-container {
            display: flex;
            gap: 10px;
        }

        .ai-input {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 12px;
            color: white;
            font-size: 16px;
        }

        .send-btn {
            background: #64ffda;
            border: none;
            color: #1e1e1e;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .send-btn:hover {
            background: #4fd3b8;
        }

        .send-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Other existing styles... */
        .device-list {
            margin-bottom: 20px;
        }

        .device-item {
            background: #1e1e1e;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #444;
        }

        .btn {
            background: #64ffda;
            border: none;
            color: #1e1e1e;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 6px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff5722;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        .terminal {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 120px;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .thinking-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #64ffda;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="status-indicator">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="connectionText">Connecting...</span>
            </div>

            <!-- Goal Tracker -->
            <div class="section-title">üéØ Current Goal</div>
            <div class="goal-tracker" id="goalTracker">
                <div class="goal-status">
                    <div class="goal-dot" id="goalDot"></div>
                    <div class="goal-text" id="goalText">No active goal</div>
                </div>
                <div class="goal-progress" id="goalProgress">Ready for instructions</div>
            </div>

            <div class="section-title">üîå Devices</div>
            <button class="btn" onclick="scanDevices()" style="width: 100%; margin-bottom: 15px;">
                Scan Devices
            </button>
            <div id="deviceList" class="device-list"></div>

            <div class="section-title">üìä System</div>
            <div style="background: #1e1e1e; padding: 10px; border-radius: 6px;">
                <div>CPU: <span id="cpuUsage">--</span></div>
                <div>Memory: <span id="memUsage">--</span></div>
            </div>

            <div class="section-title" style="margin-top: 20px;">üìú Activity</div>
            <div class="terminal" id="activityLog">
                <div>üöÄ Enhanced AI system started</div>
                <div>üéØ Goal-oriented workflow ready</div>
            </div>
        </div>

        <!-- Main Content - AI Chat -->
        <div class="main-content">
            <div class="section-title">ü§ñ AI Assistant - Goal-Oriented Workflow</div>
            
            <div class="ai-chat">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <strong>ü§ñ Real AI Assistant Ready!</strong><br>
                        I'm powered by specialized AI agents with real tools:<br>
                        <strong>üîß System Agent:</strong> disk usage, memory, processes, CPU info<br>
                        <strong>üìÅ File Agent:</strong> directory listings, file search, navigation<br>
                        <strong>üåê Network Agent:</strong> connectivity, interfaces, diagnostics<br>
                        <strong>‚ö° Device Agent:</strong> USB, IoT devices, hardware detection<br>
                        <strong>üíª Terminal Agent:</strong> safe command execution<br><br>
                        <strong>Examples:</strong><br>
                        ‚Ä¢ "check disk usage and memory" ‚Üí System Agent + tools<br>
                        ‚Ä¢ "list files in current directory" ‚Üí File Agent + tools<br>
                        ‚Ä¢ "scan for USB devices" ‚Üí Device Agent + tools<br>
                        ‚Ä¢ "test network connectivity" ‚Üí Network Agent + tools<br><br>
                        I use real AI reasoning to choose the right tools for your goals!
                    </div>
                </div>

                <div class="ai-input-container">
                    <input type="text" class="ai-input" id="aiInput" 
                           placeholder="Tell me what you want to achieve..." 
                           onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn">Send</button>
                </div>
            </div>
        </div>

        <!-- Terminal Panel -->
        <div class="terminal-panel">
            <div class="section-title">üíª Interactive Terminal</div>
            
            <div class="terminal-container">
                <div class="terminal-window">
                    <div class="terminal-header">
                        <div class="terminal-dot red"></div>
                        <div class="terminal-dot yellow"></div>
                        <div class="terminal-dot green"></div>
                        <div class="terminal-title">IoT Terminal - AI Enhanced</div>
                    </div>
                    
                    <div class="terminal-output" id="terminalOutput">
                        <div class="terminal-line success">üöÄ Enhanced IoT Control System Terminal</div>
                        <div class="terminal-line success">ü§ñ AI can now inject commands with your permission</div>
                        <div class="terminal-line success">üéØ Goal-oriented command execution active</div>
                        <div class="terminal-line">&nbsp;</div>
                    </div>
                    
                    <div class="terminal-input-line">
                        <span class="terminal-prompt">$</span>
                        <input type="text" class="terminal-input" id="terminalInput" 
                               placeholder="Enter command or let AI handle it..." 
                               onkeypress="handleTerminalKeyPress(event)"
                               autocomplete="off">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentGoal = null;
        let goalSteps = [];
        let pendingPermission = null;
        let commandHistory = [];
        let workflowActive = false;

        // Goal and workflow state
        const GoalState = {
            INACTIVE: 'inactive',
            THINKING: 'thinking',
            REQUESTING_PERMISSION: 'requesting_permission',
            EXECUTING: 'executing',
            REASONING: 'reasoning',
            ACHIEVED: 'achieved',
            FAILED: 'failed'
        };

        let currentGoalState = GoalState.INACTIVE;

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing real AI-enhanced IoT interface...');
            initializeSocket();
            updateGoalDisplay();
            addHelpButtons();
            
            setTimeout(() => {
                addTerminalLine('ü§ñ Real AI agents and tools initialized', 'success');
                addActivityLog('AI system ready with real agents', 'success');
                showExampleGoals();
            }, 1000);
        });

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus(true);
                addTerminalLine('üîó Connected to enhanced AI system', 'success');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus(false);
            });

            // Enhanced AI workflow events
            socket.on('ai_thinking', function(data) {
                handleAIThinking(data);
            });

            socket.on('ai_permission_request', function(data) {
                handlePermissionRequest(data);
            });

            socket.on('ai_executing', function(data) {
                handleAIExecuting(data);
            });

            socket.on('ai_reasoning', function(data) {
                handleAIReasoning(data);
            });

            socket.on('ai_goal_update', function(data) {
                handleGoalUpdate(data);
            });

            socket.on('terminal_output', function(data) {
                displayTerminalOutput(data);
                
                // If this was an AI-injected command, send output back for reasoning
                if (workflowActive && data.ai_injected) {
                    socket.emit('ai_process_output', {
                        command: data.command,
                        output: data.stdout,
                        error: data.stderr,
                        return_code: data.return_code,
                        goal: currentGoal
                    });
                }
            });

            socket.on('ai_workflow_complete', function(data) {
                handleWorkflowComplete(data);
            });
        }

        // Handle keyboard input for AI chat
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message to AI with goal-oriented workflow
        function sendMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';
            
            // Set new goal and start workflow
            currentGoal = message;
            workflowActive = true;
            updateGoalState(GoalState.THINKING);
            
            // Disable send button during workflow
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="thinking-indicator"></span>Thinking...';
            
            // Send to AI with enhanced context
            socket.emit('ai_goal_request', {
                goal: message,
                context: {
                    timestamp: new Date().toISOString(),
                    workflow_id: Date.now()
                }
            });
            
            addActivityLog(`New goal: ${message}`, 'info');
        }

        // Handle AI thinking phase
        function handleAIThinking(data) {
            addChatMessage(`üß† <strong>AI Thinking...</strong><br>${data.thought}`, 'ai thinking');
            
            if (data.reasoning) {
                const lastMessage = document.querySelector('#chatMessages .message:last-child');
                const reasoningDiv = document.createElement('div');
                reasoningDiv.className = 'reasoning-section';
                reasoningDiv.innerHTML = `
                    <div class="reasoning-title">üîç AI Reasoning:</div>
                    <div class="reasoning-text">${data.reasoning}</div>
                `;
                lastMessage.appendChild(reasoningDiv);
            }
            
            addActivityLog(`AI thinking: ${data.thought}`, 'info');
        }

        // Handle AI executing phase
        function handleAIExecuting(data) {
            updateGoalState(GoalState.EXECUTING);
            addChatMessage(`‚ö° <strong>AI Executing...</strong><br>Using tools: ${data.tools || 'system tools'}`, 'ai executing');
            addActivityLog(`AI executing tools for: ${data.goal || currentGoal}`, 'info');
        }

        // Handle AI reasoning about results
        function handleAIReasoning(data) {
            updateGoalState(GoalState.REASONING);
            
            const reasoningHtml = `
                <strong>ü§î AI Analyzing Results...</strong><br>
                ${data.analysis}<br>
                <div class="reasoning-section">
                    <div class="reasoning-title">üéØ Goal Assessment:</div>
                    <div class="reasoning-text">${data.goal_assessment}</div>
                </div>
            `;
            
            addChatMessage(reasoningHtml, 'ai reasoning');
            addActivityLog(`AI reasoning: ${data.analysis}`, 'info');
        }

        // Handle real AI response from agents
        function handleRealAIResponse(data) {
            console.log('Real AI Response received:', data);
            resetSendButton();
            
            const interpretation = data.interpretation || {};
            const message = data.message || interpretation.ai_response || "AI processing complete";
            
            // Show AI response with agent info
            let responseHtml = `<strong>ü§ñ AI Agent Response:</strong><br>${message}`;
            
            if (data.reasoning) {
                responseHtml += `<div class="reasoning-section">
                    <div class="reasoning-title">üß† AI Reasoning:</div>
                    <div class="reasoning-text">${data.reasoning}</div>
                </div>`;
            }
            
            if (data.actions_taken && data.actions_taken.length > 0) {
                responseHtml += `<div class="reasoning-section">
                    <div class="reasoning-title">‚ö° Actions Taken:</div>
                    <div class="reasoning-text">${data.actions_taken.join(', ')}</div>
                </div>`;
            }
            
            addChatMessage(responseHtml, 'ai');
            
            // Update activity log
            addActivityLog(`AI Agent: ${message.substring(0, 50)}...`, 'success');
        }

        // Handle workflow started
        function handleWorkflowStarted(data) {
            addChatMessage(`üöÄ <strong>AI Workflow Started</strong><br>${data.message}`, 'ai');
            addActivityLog(`Workflow started: ${data.workflow_id}`, 'info');
        }

        // Handle permission result
        function handlePermissionResult(data) {
            const status = data.status;
            let message = '';
            let messageType = 'ai';
            
            if (status === 'executed') {
                message = `‚úÖ <strong>Command Executed Successfully</strong><br>Command: ${data.command}`;
                messageType = 'ai goal-achieved';
                addActivityLog(`Command executed: ${data.command}`, 'success');
            } else if (status === 'denied') {
                message = `‚ùå <strong>Permission Denied</strong><br>${data.message}`;
                messageType = 'ai goal-failed';
                addActivityLog('Permission denied by user', 'warning');
            } else {
                message = `‚ö†Ô∏è <strong>Permission Error</strong><br>${data.message}`;
                messageType = 'ai goal-failed';
                addActivityLog(`Permission error: ${data.message}`, 'error');
            }
            
            addChatMessage(message, messageType);
        }

        // Handle AI help response
        function handleAIHelpResponse(data) {
            const helpHtml = `<strong>üìö Help: ${data.topic}</strong><br><pre style="white-space: pre-wrap; font-family: inherit;">${data.content}</pre>`;
            addChatMessage(helpHtml, 'ai');
        }

        // Enhanced permission granting
        function grantPermission(allowed) {
            if (!pendingPermission) return;
            
            const response = {
                permission_id: pendingPermission.permission_id,
                allowed: allowed,
                workflow_id: pendingPermission.workflow_id
            };
            
            socket.emit('ai_permission_response', response);
            
            // Update UI
            const permissionBtns = document.querySelectorAll('.permission-buttons');
            permissionBtns.forEach(btns => {
                btns.innerHTML = allowed ? 
                    '<span style="color: #4caf50;">‚úÖ Permission Granted - Executing...</span>' :
                    '<span style="color: #f44336;">‚ùå Permission Denied</span>';
            });
            
            if (allowed) {
                updateGoalState(GoalState.EXECUTING);
                addActivityLog(`Permission granted for: ${pendingPermission.command}`, 'success');
            } else {
                updateGoalState(GoalState.FAILED);
                addActivityLog(`Permission denied for: ${pendingPermission.command}`, 'error');
                resetWorkflow();
            }
            
            pendingPermission = null;
        }

        // Request AI help
        function requestAIHelp(topic = 'general') {
            socket.emit('request_ai_help', { topic: topic });
        }

        // Add help buttons to the interface
        function addHelpButtons() {
            const sidebar = document.querySelector('.sidebar');
            const helpSection = document.createElement('div');
            helpSection.innerHTML = `
                <div class="section-title" style="margin-top: 20px;">‚ùì AI Help</div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button class="btn" onclick="requestAIHelp('general')" style="width: 100%; font-size: 11px;">General Help</button>
                    <button class="btn" onclick="requestAIHelp('tools')" style="width: 100%; font-size: 11px;">Available Tools</button>
                    <button class="btn" onclick="requestAIHelp('workflow')" style="width: 100%; font-size: 11px;">How AI Works</button>
                </div>
            `;
            sidebar.appendChild(helpSection);
        }

        // Enhanced message sending with examples
        function showExampleGoals() {
            const examples = [
                "check disk usage and memory info",
                "list files in current directory", 
                "scan for USB devices",
                "test network connectivity",
                "show running processes",
                "find all .txt files",
                "get system information"
            ];
            
            const exampleHtml = `
                <strong>üí° Try these example goals:</strong><br>
                ${examples.map(ex => `‚Ä¢ <span style="cursor: pointer; color: #64ffda;" onclick="setGoal('${ex}')">${ex}</span>`).join('<br>')}
            `;
            
            addChatMessage(exampleHtml, 'ai');
        }

        // Set goal in input
        function setGoal(goalText) {
            document.getElementById('aiInput').value = goalText;
            document.getElementById('aiInput').focus();
        }

        // Enhanced terminal display
        function displayTerminalOutput(data) {
            // Show command with special styling for AI-injected commands
            const commandClass = data.ai_injected ? 'ai-injected' : 'command';
            const prefix = data.ai_injected ? 'ü§ñ AI $ ' : '$ ';
            addTerminalLine(`${prefix}${data.command}`, commandClass);
            
            // Show output
            if (data.stdout && data.stdout.trim()) {
                // Split long output into manageable chunks
                const lines = data.stdout.trim().split('\n');
                lines.forEach(line => {
                    if (line.trim()) {
                        addTerminalLine(line, 'output');
                    }
                });
            }
            
            if (data.stderr && data.stderr.trim()) {
                addTerminalLine(data.stderr.trim(), 'error');
            }
            
            // Show return code if non-zero or if AI injected
            if (data.return_code !== 0 || data.ai_injected) {
                const statusText = data.return_code === 0 ? '‚úÖ Success' : `‚ùå Exit code: ${data.return_code}`;
                addTerminalLine(statusText, data.return_code === 0 ? 'success' : 'error');
            }
            
            // Add separator for AI commands
            if (data.ai_injected) {
                addTerminalLine('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'output');
            }
        }

        // Handle permission request from real AI agents
        function handlePermissionRequest(data) {
            updateGoalState(GoalState.REQUESTING_PERMISSION);
            pendingPermission = data;
            
            const riskColor = {
                'low': '#4caf50',
                'medium': '#ff9800', 
                'high': '#f44336'
            };
            
            const permissionHtml = `
                <div class="permission-request">
                    <strong>üîê AI Agent Permission Required</strong><br>
                    ${data.explanation}<br>
                    <div class="permission-command">$ ${data.command}</div>
                    <div style="font-size: 12px; color: #ccc; margin: 5px 0;">
                        Expected outcome: ${data.expected_outcome || 'Information gathering'}
                    </div>
                    <div style="font-size: 11px; color: ${riskColor[data.risk_level] || '#ccc'}; margin: 5px 0;">
                        Risk level: ${data.risk_level || 'low'}
                    </div>
                    <div class="permission-buttons">
                        <button class="permission-btn allow" onclick="grantPermission(true)">‚úÖ Allow</button>
                        <button class="permission-btn deny" onclick="grantPermission(false)">‚ùå Deny</button>
                        <button class="permission-btn modify" onclick="modifyCommand()">‚úèÔ∏è Modify</button>
                    </div>
                </div>
            `;
            
            addChatMessage(permissionHtml, 'ai permission');
            addActivityLog(`AI requests permission for: ${data.command}`, 'warning');
        }

        // Grant or deny permission
        function grantPermission(allowed) {
            if (!pendingPermission) return;
            
            const response = {
                workflow_id: pendingPermission.workflow_id,
                allowed: allowed,
                command: pendingPermission.command
            };
            
            socket.emit('ai_permission_response', response);
            
            // Update UI
            const permissionBtns = document.querySelectorAll('.permission-buttons');
            permissionBtns.forEach(btns => {
                btns.innerHTML = allowed ? 
                    '<span style="color: #4caf50;">‚úÖ Permission Granted</span>' :
                    '<span style="color: #f44336;">‚ùå Permission Denied</span>';
            });
            
            if (allowed) {
                updateGoalState(GoalState.EXECUTING);
                addActivityLog(`Permission granted for: ${pendingPermission.command}`, 'success');
            } else {
                updateGoalState(GoalState.FAILED);
                addActivityLog(`Permission denied for: ${pendingPermission.command}`, 'error');
                resetWorkflow();
            }
            
            pendingPermission = null;
        }

        // Modify command (enhanced for real AI workflow)
        function modifyCommand() {
            if (!pendingPermission) return;
            
            const newCommand = prompt("Modify the command:", pendingPermission.command);
            if (newCommand && newCommand.trim() && newCommand !== pendingPermission.command) {
                // Send modified permission response
                const response = {
                    permission_id: pendingPermission.permission_id,
                    allowed: true,
                    modified_command: newCommand.trim(),
                    workflow_id: pendingPermission.workflow_id
                };
                
                socket.emit('ai_permission_response', response);
                
                // Update UI
                const permissionBtns = document.querySelectorAll('.permission-buttons');
                permissionBtns.forEach(btns => {
                    btns.innerHTML = `<span style="color: #ff9800;">‚úèÔ∏è Modified and approved: ${newCommand}</span>`;
                });
                
                updateGoalState(GoalState.EXECUTING);
                addActivityLog(`Command modified and approved: ${newCommand}`, 'success');
                pendingPermission = null;
            }
        }

        // Handle AI executing phase
        function handleAIExecuting(data) {
            updateGoalState(GoalState.EXECUTING);
            addChatMessage(`‚ö° <strong>Executing command...</strong><br>$ ${data.command}`, 'ai executing');
            addActivityLog(`AI executing: ${data.command}`, 'info');
        }

        // Handle AI reasoning about output
        function handleAIReasoning(data) {
            updateGoalState(GoalState.REASONING);
            
            const reasoningHtml = `
                <strong>ü§î Analyzing results...</strong><br>
                ${data.analysis}<br>
                <div class="reasoning-section">
                    <div class="reasoning-title">üéØ Goal Assessment:</div>
                    <div class="reasoning-text">${data.goal_assessment}</div>
                </div>
            `;
            
            addChatMessage(reasoningHtml, 'ai reasoning');
            addActivityLog(`AI reasoning: ${data.analysis}`, 'info');
        }

        // Handle goal updates
        function handleGoalUpdate(data) {
            if (data.status === 'achieved') {
                updateGoalState(GoalState.ACHIEVED);
                addChatMessage(`üéâ <strong>Goal Achieved!</strong><br>${data.message}`, 'ai goal-achieved');
                addActivityLog(`Goal achieved: ${data.message}`, 'success');
                resetWorkflow();
            } else if (data.status === 'failed') {
                updateGoalState(GoalState.FAILED);
                addChatMessage(`‚ùå <strong>Goal Failed</strong><br>${data.message}`, 'ai goal-failed');
                addActivityLog(`Goal failed: ${data.message}`, 'error');
                resetWorkflow();
            } else if (data.status === 'progress') {
                addChatMessage(`üîÑ <strong>Making progress...</strong><br>${data.message}`, 'ai');
                addActivityLog(`Goal progress: ${data.message}`, 'info');
            }
        }

        // Handle workflow completion
        function handleWorkflowComplete(data) {
            const isSuccess = data.status === 'achieved';
            updateGoalState(isSuccess ? GoalState.ACHIEVED : GoalState.FAILED);
            
            const finalMessage = `
                <strong>${isSuccess ? 'üéâ Workflow Complete!' : '‚ùå Workflow Incomplete'}</strong><br>
                ${data.summary}<br>
                <small style="color: #888;">Steps taken: ${data.steps_taken}</small>
            `;
            
            addChatMessage(finalMessage, isSuccess ? 'ai goal-achieved' : 'ai goal-failed');
            resetWorkflow();
        }

        // Display terminal output
        function displayTerminalOutput(data) {
            // Show command
            addTerminalLine(`$ ${data.command}`, data.ai_injected ? 'ai-injected' : 'command');
            
            // Show output
            if (data.stdout && data.stdout.trim()) {
                addTerminalLine(data.stdout.trim(), 'output');
            }
            if (data.stderr && data.stderr.trim()) {
                addTerminalLine(data.stderr.trim(), 'error');
            }
            
            // Show return code if non-zero
            if (data.return_code !== 0) {
                addTerminalLine(`Exit code: ${data.return_code}`, 'error');
            }
        }

        // Update goal state and display
        function updateGoalState(newState) {
            currentGoalState = newState;
            updateGoalDisplay();
        }

        // Update goal display in sidebar
        function updateGoalDisplay() {
            const goalDot = document.getElementById('goalDot');
            const goalText = document.getElementById('goalText');
            const goalProgress = document.getElementById('goalProgress');
            
            // Remove all state classes
            goalDot.className = 'goal-dot';
            
            switch (currentGoalState) {
                case GoalState.INACTIVE:
                    goalText.textContent = 'No active goal';
                    goalProgress.textContent = 'Ready for instructions';
                    break;
                case GoalState.THINKING:
                    goalDot.classList.add('active');
                    goalText.textContent = currentGoal || 'Processing...';
                    goalProgress.textContent = 'AI is thinking...';
                    break;
                case GoalState.REQUESTING_PERMISSION:
                    goalDot.classList.add('active');
                    goalProgress.textContent = 'Waiting for permission...';
                    break;
                case GoalState.EXECUTING:
                    goalDot.classList.add('active');
                    goalProgress.textContent = 'Executing command...';
                    break;
                case GoalState.REASONING:
                    goalDot.classList.add('active');
                    goalProgress.textContent = 'Analyzing results...';
                    break;
                case GoalState.ACHIEVED:
                    goalDot.classList.add('success');
                    goalProgress.textContent = 'Goal successfully achieved!';
                    break;
                case GoalState.FAILED:
                    goalDot.classList.add('failed');
                    goalProgress.textContent = 'Goal could not be achieved';
                    break;
            }
        }

        // Reset workflow state
        function resetWorkflow() {
            workflowActive = false;
            currentGoal = null;
            pendingPermission = null;
            
            // Re-enable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
            
            // Reset to inactive state after a delay
            setTimeout(() => {
                updateGoalState(GoalState.INACTIVE);
            }, 3000);
        }

        // Terminal functions
        function handleTerminalKeyPress(event) {
            const input = document.getElementById('terminalInput');
            
            if (event.key === 'Enter') {
                const command = input.value.trim();
                if (command) {
                    executeCommand(command, false); // false = not AI injected
                    input.value = '';
                }
            }
        }

        function executeCommand(command, aiInjected = false) {
            socket.emit('terminal_command', {
                command: command,
                ai_injected: aiInjected,
                session_id: 'main_terminal'
            });
        }

        // Utility functions
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTerminalLine(text, type = 'output') {
            const terminal = document.getElementById('terminalOutput');
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
            
            // Keep only last 1000 lines
            while (terminal.children.length > 1000) {
                terminal.removeChild(terminal.firstChild);
            }
        }

        function addActivityLog(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(line);
            log.scrollTop = log.scrollHeight;
            
            while (log.children.length > 50) {
                log.removeChild(log.firstChild);
            }
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
            }
        }

        // Device management functions
        async function scanDevices() {
            try {
                const response = await fetch('/api/devices/scan');
                const devices = await response.json();
                updateDeviceList(devices);
                addActivityLog(`Found ${devices.length} devices`, 'info');
            } catch (error) {
                addActivityLog(`Device scan failed: ${error.message}`, 'error');
            }
        }

        function updateDeviceList(devices) {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';
            
            if (!devices || devices.length === 0) {
                deviceList.innerHTML = '<div style="color: #888; font-style: italic;">No devices found</div>';
                return;
            }
            
            devices.forEach(device => {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device-item';
                deviceDiv.innerHTML = `
                    <div style="color: #64ffda; font-weight: bold; margin-bottom: 5px;">${device.port}</div>
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">${device.description}</div>
                    <button class="btn" onclick="connectDevice('${device.port}')">Connect</button>
                `;
                deviceList.appendChild(deviceDiv);
            });
        }

        async function connectDevice(port) {
            try {
                const response = await fetch('/api/devices/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: port })
                });
                
                const result = await response.json();
                if (result.success) {
                    addTerminalLine(`üîå Connected to ${port}`, 'success');
                    addActivityLog(`Connected to ${port}`, 'success');
                } else {
                    addTerminalLine(`‚ùå Connection failed: ${result.message}`, 'error');
                }
            } catch (error) {
                addTerminalLine(`‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        // Debug function to check system status
        function debugSystem() {
            console.log('=== AI System Debug ===');
            console.log('Socket connected:', socket && socket.connected);
            console.log('Current goal:', currentGoal);
            console.log('Workflow active:', workflowActive);
            console.log('Goal state:', currentGoalState);
            console.log('Functions loaded:', {
                handleAIThinking: typeof handleAIThinking,
                handleRealAIResponse: typeof handleRealAIResponse,
                handlePermissionRequest: typeof handlePermissionRequest,
                displayTerminalOutput: typeof displayTerminalOutput
            });
            
            // Test message
            addChatMessage('üîß Debug: All systems operational!', 'ai');
            addTerminalLine('Debug: Function check completed', 'success');
        }

        // Make debug function available globally
        window.debugSystem = debugSystem;
        window.setGoal = setGoal;
        window.requestAIHelp = requestAIHelp;
        window.grantPermission = grantPermission;
        window.modifyCommand = modifyCommand;

        console.log('‚úÖ Real AI IoT interface loaded successfully');
        console.log('üîß Available functions:', Object.keys(window).filter(k => k.startsWith('debug') || k.startsWith('setGoal') || k.startsWith('requestAI')));
        console.log('üí° Try: debugSystem() in console for system status');
    </script>
</body>
</html>